{% extends 'base.html' %}

{% block titulo %}
Ventas
{% endblock %}

{% block contenido %}
<div class="mt-3">

  <h4 class="mb-3">Ventas del día</h4>

  <!-- FORMULARIO DE VENTA -->
  <div class="card mb-3">
    <div class="card-body">

      <div class="form-row">

        <!-- PRODUCTO -->
        <div class="col-12 col-md-5 mb-2">
          <label>Producto</label>
          <select class="form-control" id="producto_id">
            {% for p in productos %}
              <option value="{{ p.id }}">
                {{ p.nombre }} (Stock: {{ p.stock }})
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- CANTIDAD -->
        <div class="col-6 col-md-2 mb-2">
          <label>Cantidad</label>
          <input
            class="form-control"
            type="number"
            id="cantidad"
            value="1"
            min="1">
        </div>

        <!-- MÉTODO DE PAGO -->
        <div class="col-6 col-md-3 mb-2">
          <label>Método de pago</label>
          <select class="form-control" id="metodo_pago">
            <option value="efectivo">Efectivo</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>

        <!-- BOTÓN -->
        <div class="col-12 col-md-2 mb-2 d-flex align-items-end">
          <button class="btn btn-primary btn-block btn-lg" id="btnVender">
            Registrar venta
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- TOTALES DEL DÍA -->
  <div class="alert alert-info text-center text-md-left">
    <div class="row">
      <div class="col-12 col-md-4 mb-2 mb-md-0">
        <strong>Total del día</strong><br>
        ₲ <span id="totalDia">0</span>
      </div>
      <div class="col-6 col-md-4">
        <strong>Efectivo</strong><br>
        ₲ <span id="totalEfectivo">0</span>
      </div>
      <div class="col-6 col-md-4">
        <strong>Transferencia</strong><br>
        ₲ <span id="totalTransferencia">0</span>
      </div>
    </div>
  </div>

  <!-- TABLA DE VENTAS -->
  <div class="table-responsive">
    <table class="table table-striped table-sm" id="tblVentas">
      <thead class="thead-dark">
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Producto</th>
          <th>Cant.</th>
          <th>Precio</th>
          <th>Subtotal</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>
{% endblock %}

{% block js %}
<script>
  const URL_API = "/ventas/api";
  let tabla = null;

  const cargarTabla = () => {
    if (tabla) {
      tabla.ajax.reload(null, false);
      return;
    }

    tabla = $("#tblVentas").DataTable({
      responsive: false,
      pageLength: 5,
      lengthChange: false,
      searching: false,
      ajax: {
        url: URL_API,
        dataSrc: function (json) {
          const r = json.resumen || {
            total_dia: 0,
            total_efectivo: 0,
            total_transferencia: 0
          };

          document.getElementById("totalDia").textContent = r.total_dia;
          document.getElementById("totalEfectivo").textContent = r.total_efectivo;
          document.getElementById("totalTransferencia").textContent = r.total_transferencia;

          return json.data || [];
        }
      },
      order: [[1, "desc"]],
      columns: [
        { data: "venta_id" },
        { data: "fecha" },
        { data: "producto" },
        { data: "cantidad" },
        { data: "precio_unitario" },
        { data: "subtotal" },
        { data: "total" }
      ]
    });
  };

  const vender = async () => {
    const producto_id = parseInt(document.getElementById("producto_id").value, 10);
    const cantidad = parseInt(document.getElementById("cantidad").value, 10);
    const metodo_pago = document.getElementById("metodo_pago").value;

    if (!producto_id || cantidad <= 0) {
      Swal.fire("Atención", "Datos de venta inválidos", "warning");
      return;
    }

    const resp = await fetch(URL_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ producto_id, cantidad, metodo_pago })
    });

    const data = await resp.json();

    if (!resp.ok || !data.success) {
      Swal.fire("Error", data.error || "No se pudo registrar la venta", "error");
      return;
    }

    Swal.fire("Venta registrada", "La venta fue guardada correctamente", "success");
    cargarTabla();
  };

  $(document).ready(function () {
    cargarTabla();
    $("#btnVender").on("click", vender);
  });
</script>
{% endblock %}
